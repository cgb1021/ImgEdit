function asyncGeneratorStep(t,e,n,r,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void n(t)}s.done?e(c):Promise.resolve(c).then(r,o)}function _asyncToGenerator(s){return function(){var t=this,a=arguments;return new Promise(function(e,n){var r=s.apply(t,a);function o(t){asyncGeneratorStep(r,e,n,o,i,"next",t)}function i(t){asyncGeneratorStep(r,e,n,o,i,"throw",t)}o(void 0)})}}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(n="Object"===n&&t.constructor?t.constructor.name:n)||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function _iterableToArrayLimit(t,e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t)){var n=[],r=!0,o=!1,i=void 0;try{for(var a,s=t[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{r||null==s.return||s.return()}finally{if(o)throw i}}return n}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),t}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}!function(t,e){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).imgedit={})}(this,function(t){"use strict";function tt(t,e,n){var r=Math.sin(t),t=Math.cos(t);return[e*t+n*r,n*t-e*r]}function et(t,e){t=t.sort(function(t,e){return t-e}),e=e.sort(function(t,e){return t-e});var n=null,r=null;return t[3]>e[0]&&e[1]>t[0]&&(n=(e[0]<=t[0]?t:e)[0],r=e[1]<=t[3]?e[1]:t[3]),[n,r]}function c(i){return new Promise(function(r,e){i&&"string"==typeof i&&/^(?:https?:)?\/\//i.test(i)||e(0);var o=new XMLHttpRequest;o.responseType="blob",o.onload=function(){var t=o.response,e="",n=i.match(/[\w.-]+\.(?:jpe?g|png|gif|bmp)$/);e=n?n[0]:(e=Date.now(),"jpeg"===(n=t.type.split("/")[1])?"".concat(e,".jpg"):"".concat(e,".").concat(n)),t.name=e,r(t)},o.onerror=function(t){console.error("fetchImg err",t),e(t)},o.open("GET",i),o.send(null)})}var u=function(){function n(t,e){var E=this;_classCallCheck(this,n);var N=null,G=null,B=0,F=0,K=0,z=0,H=1,$=1,q=0,W=0,J=0,Q=0,V=0;function Z(){var t,e,n,r,o,i,a;N&&(t=G.getContext("2d"),e=B*H,n=F*$,r=G.width,o=G.height,i=W,a=J,G.height=o,t.save(),q&&(t.translate(r/2|0,o/2|0),t.rotate(q*Math.PI/180),i-=.5*e,a-=.5*n),t.drawImage(N,0|K,0|z,0|B,0|F,0|i,0|a,0|e,0|n),t.restore())}Object.defineProperties(this,{canvas:{set:function(t){var e;(G="object"!==_typeof(e=t)?/^\w+$/.test(e)?document.getElementById(e):document.querySelector(e):e instanceof HTMLElement?e:null)&&"getContext"in G||(G=document.createElement("canvas")),N&&(Q=B*H,V=F*$,e=(90<(t=q%180)?180-t:t)*(Math.PI/180),t=Math.sin(e),e=Math.cos(e),G.width=Q*e+V*t|0,G.height=V*e+Q*t|0,Z())}},src:{set:function(t){t&&(t instanceof Image||"getContext"in t)&&(N=t,W=J=K=z=q=0,H=$=1,G.width=Q=B=t.width,G.height=V=F=t.height,Z())},get:function(){return G}},width:{get:function(){return G.width}},height:{get:function(){return G.height}},sw:{set:function(t){(t=+t)&&0<t&&(B=t)},get:function(){return B}},sh:{set:function(t){(t=+t)&&0<t&&(F=t)},get:function(){return F}},sx:{set:function(t){t=+t,!isNaN(t)&&0<=t&&(K=t)},get:function(){return K}},sy:{set:function(t){t=+t,!isNaN(t)&&0<=t&&(z=t)},get:function(){return z}},angle:{set:function(t){t=+t,isNaN(t)||(q=(360+t)%360)},get:function(){return q}},rx:{set:function(t){(t=+t)&&0<t&&(H=t)},get:function(){return H}},ry:{set:function(t){(t=+t)&&0<t&&($=t)},get:function(){return $}},dx:{set:function(t){t=+t,!isNaN(t)&&0<=t&&(W=t)},get:function(){return W}},dy:{set:function(t){t=+t,!isNaN(t)&&0<=t&&(J=t)},get:function(){return J}},cw:{set:function(t){(t=+t)&&0<t&&(Q=t)},get:function(){return Q}},ch:{set:function(t){(t=+t)&&0<t&&(V=t)},get:function(){return V}}}),this.toJSON=function(){return{sw:B,sh:F,sx:K,sy:z,angle:q,rx:H,ry:$,dx:W,dy:J,cw:Q,ch:V}},this.fromJSON=function(t){for(var e in t){void 0!==E[e]&&(E[e]=t[e]);var n=q%180,e=(90<n?180-n:n)*(Math.PI/180),n=Math.sin(e),e=Math.cos(e);G.width=Q*e+V*n|0,G.height=V*e+Q*n|0}Z()},this.resize=function(){var t,e,n,r,o,i,a;return N&&(t=G.width,e=G.height,a=i=0,arguments.length?(n=+(arguments.length<=0?void 0:arguments[0]),o=1<arguments.length?+(arguments.length<=1?void 0:arguments[1]):0,r=t/e,n&&o?(i=n,a=o):n?a=(i=n)/r:o&&(i=o*r,a=o),H*=r=i/t,$*=o=a/e,Q*=r,V*=o):(o=(90<(r=q%180)?180-r:r)*(Math.PI/180),r=Math.sin(o),o=Math.cos(o),i=(Q=B*H)*o+(V=F*$)*r,a=V*o+Q*r),G.width=0|i,G.height=0|a,Z()),E},this.crop=function(){if(N&&arguments.length){var t=+(arguments.length<=0?void 0:arguments[0]),e=1<arguments.length?+(arguments.length<=1?void 0:arguments[1]):G.height,n=2<arguments.length?+(arguments.length<=2?void 0:arguments[2]):0,r=3<arguments.length?+(arguments.length<=3?void 0:arguments[3]):0,o=B*H,i=F*$,a=0;q%90?q<90||180<q&&q<270?a=(q-(180<q?180:0))*(Math.PI/180):(a=(q-(270<q?270:90))*(Math.PI/180),o=(Y=[i,o])[0],i=Y[1]):90!==q&&270!==q||(o=(D=[i,o])[0],i=D[1]);var s=Math.sin(a),c=Math.cos(a),u=o*s,h=o*c,f=i*s,l=i*c,g=G.width,d=G.height,y=_slicedToArray(tt(a,f,0),2),p=y[0],v=y[1],m=_slicedToArray(tt(a,g,u),1)[0],w=_slicedToArray(tt(a,0,l),2)[1],b=_slicedToArray(tt(a,n,r),2),x=b[0],M=b[1],_=_slicedToArray(tt(a,n+t,r),2),k=_[0],T=_[1],I=_slicedToArray(tt(a,n+t,r+e),2),j=I[0],A=I[1],R=_slicedToArray(tt(a,n,r+e),2),P=R[0],L=R[1],S=_slicedToArray(et([x,k,j,P],[p,m]),2),X=S[0],C=S[1],O=_slicedToArray(et([M,T,A,L],[v,w]),2),Y=O[0],D=O[1];if(null===X||null===C||null===Y||null===D)return console.log("没有相交"),E;var U,s=C-X,c=D-Y,y=0,b=0,_=t,I=e;(Math.round(s)<Math.round(o)||Math.round(c)<Math.round(i))&&(q%90&&(R=Math.tan(a),S=n,O=r,k<p&&(I-=U=(f-n-t)/R-r,O+=U),P<p&&(_-=U=(l-r-e)*R-n,S+=U),m<k&&(_-=n+t-(g-(r-u)*R)),m<P&&(I-=r+e-(d-(n-h)/R)),M<v&&(I-=f=(n-f)*R-r,O+=f),A<v&&(_-=n+t-(g-(u-r-e)/R)),w<M&&(_-=u=(r-l)/R-n,S+=u),w<A&&(I-=r+e-(l+(n+t)*R)),x=(R=_slicedToArray(tt(a,S,O),2))[0],M=R[1],k=(R=_slicedToArray(tt(a,S+_,O),2))[0],T=R[1],j=(R=_slicedToArray(tt(a,S+_,O+I),2))[0],A=R[1],P=(O=_slicedToArray(tt(a,S,O+I),2))[0],L=O[1],X=(P=_slicedToArray(et([x,k,j,P],[p,m]),2))[0],C=P[1],Y=(A=_slicedToArray(et([M,T,A,L],[v,w]),2))[0],D=A[1]),s=C-X,c=D-Y,q<90?(K+=(X-p)/H,z+=(Y-v)/$,(s<o||c<i)&&(B=s/H,F=c/$)):q<180?(K+=(Y-v)/H,z+=(o-(X-p)-s)/$,(c<o||s<i)&&(B=c/H,F=s/$)):q<270?(K+=(o-(X-p)-s)/H,z+=(i-(Y-v)-c)/$,(s<o||c<i)&&(B=s/H,F=c/$)):(K+=(i-(Y-v)-c)/H,z+=(X-p)/$,(c<o||s<i)&&(B=c/H,F=s/$))),V=q%90?(q<90?(x<p&&(y+=p-x),m<j&&(y-=j-m),T<v&&(b+=v-T),w<L&&(b-=L-w)):q<180?(x<p&&(b-=p-x),m<j&&(b+=j-m),T<v&&(y+=v-T),w<L&&(y-=L-w)):q<270?(x<p&&(y-=p-x),m<j&&(y+=j-m),T<v&&(b-=v-T),w<L&&(b+=L-w)):(x<p&&(b+=p-x),m<j&&(b-=j-m),T<v&&(y-=v-T),w<L&&(y+=L-w)),W+=.5*y,J+=.5*b,y=(90<(w=q%180)?180-w:w)*(Math.PI/180),b=Math.sin(y),w=Math.cos(y),y=Math.tan(y),Q=(_-I*y)/(w-b*y),(I-_*y)/(w-b*y)):(Q=_,I),G.width=0|_,G.height=0|I,Z()}return E},this.rotate=function(t){var e;return N&&(E.angle=t,e=(90<(t=q%180)?180-t:t)*(Math.PI/180),t=Math.sin(e),e=Math.cos(e),G.width=Q*e+V*t|0,G.height=V*e+Q*t|0,Z()),E},this.draw=Z,this.src=t,this.canvas=e,t=e=null}return _createClass(n,[{key:"toDataURL",value:function(){var e=this,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"image/jpeg",r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.8;return new Promise(function(t){t(e.src.toDataURL(n,r))})}},{key:"toBlob",value:function(){var t=this,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"image/jpeg",r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.8;return new Promise(function(e){t.src.toBlob(function(t){e(t)},n,r)})}},{key:"toFile",value:function(n){var t=this,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"image/jpeg",o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:.8;return new Promise(function(e){t.src.toBlob(function(t){e(new File([t],String(n),{type:r,lastModified:Date.now()}))},r,o)})}}]),n}(),e=function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function t(e,n,r){var o,i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(n||r){t.next=2;break}return t.abrupt("return",!1);case 2:if("string"==typeof e&&/^(?:https?:)?\/\//.test(e))return t.next=5,c(e);t.next=6;break;case 5:e=t.sent;case 6:return i=e.type,o=new u(e),i=o.resize(n,r).toDataURL(i),t.abrupt("return",i);case 10:case"end":return t.stop()}},t)}));return function(t,e,n){return r.apply(this,arguments)}}(),n=function(){var i=_asyncToGenerator(regeneratorRuntime.mark(function t(e,n,r,o,i){var a,s;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(n||r){t.next=2;break}return t.abrupt("return",!1);case 2:if("string"==typeof e&&/^(?:https?:)?\/\//.test(e))return t.next=5,c(e);t.next=6;break;case 5:e=t.sent;case 6:return s=e.type,a=new u(e),s=a.cut(n,r,o,i).toDataURL(s),t.abrupt("return",s);case 10:case"end":return t.stop()}},t)}));return function(t,e,n,r,o){return i.apply(this,arguments)}}(),h={rotate:function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function t(e,n){var r,o;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(n){t.next=2;break}return t.abrupt("return",!1);case 2:if("string"==typeof e&&/^(?:https?:)?\/\//.test(e))return t.next=5,c(e);t.next=6;break;case 5:e=t.sent;case 6:return o=e.type,r=new u(e),o=r.rotate(n).toDataURL(o),t.abrupt("return",o);case 10:case"end":return t.stop()}},t)}));return function(t,e){return n.apply(this,arguments)}}(),cut:n,resize:e,preview:function(r){return new Promise(function(t,e){r&&"object"===_typeof(r)||e(0);var n=new Image;n.onload=function(){URL.revokeObjectURL(this.src)},n.onerror=function(t){e(t)},n.src=URL.createObjectURL(r),t(n)})},readFile:function(t){return new Promise(function(e,n){t&&"object"===_typeof(t)||n(0);var r=new FileReader;r.onload=function(t){e(t.target.result),r=r.onload=r.onerror=null},r.onerror=function(t){console.error("readFile error",t),r=r.onload=r.onerror=null,n(t)},r.readAsDataURL(t)})},loadImg:function(r){return new Promise(function(t,e){var n;r&&"string"==typeof r&&/^(?:data:image\/[^;]+;\s*base64\s*,|(?:https?:)?\/\/)/i.test(r)?((n=new Image).crossOrigin="anonymous",n.onload=function(){t(this),n=n.onload=n.onerror=null},n.onerror=function(t){console.error("loadImg error",t),n=n.onload=n.onerror=null,e(t)},n.src=r):e(0)})},fetchImg:c};var v={active:!1,offsetX:0,offsetY:0,ctrlKey:!1};t.Editor=function(){function s(t){var l=this;_classCallCheck(this,s);var g=new u,e=function(t){t.preventDefault(),t.stopPropagation();var e,n,r,o=this.view,i=o.x,a=o.y,s=o.ratio,c=(o=this.src).width,u=o.height;switch(t.type){case"mousedown":v.ctrlKey=t.ctrlKey,v.offsetX=t.offsetX,v.offsetY=t.offsetY,!v.ctrlKey&&t.offsetX>i&&t.offsetY>a&&t.offsetX<i+c*s&&t.offsetY<a+u*s&&(v.active=!0,v.offsetX=t.offsetX-i,v.offsetY=t.offsetY-a);break;case"mouseout":case"mouseup":v.active=!1,v.ctrlKey=!1;break;case"mousemove":v.ctrlKey?(e=Math.min(t.offsetX,v.offsetX),h=Math.min(t.offsetY,v.offsetY),n=Math.max(t.offsetX,v.offsetX)-e,r=Math.max(t.offsetY,v.offsetY)-h,this.range={width:n,height:r,x:e,y:h}):v.active&&(this.view={x:t.offsetX-v.offsetX,y:t.offsetY-v.offsetY});break;case"mousewheel":var h=t.wheelDelta?0<t.wheelDelta?0:1:0<t.detail?0:1;v.offsetX=t.offsetX,v.offsetY=t.offsetY,this.scale(s+(h?.1:-.1),1)}}.bind(this),n=["mousewheel","mousedown","mouseup","mouseout","mousemove"],r=[],o={width:0,height:0,angle:0,rx:1,ry:1},f={ratio:1,x:0,y:0},d={x:0,y:0,width:0,height:0},y=[],i=0,p=null;Object.defineProperties(this,{historyIndex:{set:function(t){"number"==typeof t&&t!==i&&(i=Math.max(0,Math.min(r.length-1,t)))},get:function(){return i}},state:{get:function(){return r.length?r[i]:Object.assign({},o)}},view:{set:function(t){t&&"object"===_typeof(t)&&(Object.assign(f,t),a(),this.draw())},get:function(){return f}},range:{set:function(t){t&&"object"===_typeof(t)&&(Object.assign(d,t),a(),this.draw())},get:function(){return d}},canvas:{set:function(t){this.destroy(),(p="object"!==_typeof(t=t)?/^\w+$/.test(t)?document.getElementById(t):document.querySelector(t):t instanceof HTMLElement?t:null)&&"getContext"in p?n.forEach(function(t){p.addEventListener(t,e,!1)}):p=null},get:function(){return p}},src:{get:function(){return g.src}}});var a=function(t){var e=l.state;return"function"==typeof l.onChange&&l.onChange(Object.assign({},e,f,{range:d},t)),Object.assign({},e,t)};this.push=function(t){t&&"object"===_typeof(t)&&(r.length&&i!==r.length-1&&r.splice(i+1),r.push(a(t)),i=r.length-1,l.draw())},this.save=function(){var t;r.length<2||(t=l.state,i=0,r.length=0,r.push(t))},this.clean=function(){i=0,r.length=0},this.draw=function(){if(p){for(var t=p.getContext("2d"),e=g.src,n=l.view,r=n.x,o=n.y,i=n.ratio,a=l.state,n=a.width,a=a.height,s=y.length-1;0<=s;s--){var c=y[s],u=c.x,h=c.y,f=c.width,c=c.height;f&&c&&t.clearRect(0|u,0|h,0|f,0|c)}"function"==typeof l.before&&l.before(t),t.drawImage(e,0|r,0|o,n*i|0,a*i|0),y[0]={x:Math.max(0,r),y:Math.max(0,o),width:Math.min(p.width,n*i),height:Math.min(p.height,a*i)},d.width&&d.height&&(t.setLineDash([5,2]),t.strokeStyle="black",t.lineWidth=1,t.strokeRect(d.x,d.y,d.width,d.height),y[1]={x:Math.max(0,d.x-1),y:Math.max(0,d.y-1),width:d.width+2,height:d.height+2}),"function"==typeof l.after&&l.after(t)}},this.open=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var n,r,o,i,a,s;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(p&&e){t.next=2;break}return t.abrupt("return");case 2:if(t.prev=2,!(e instanceof Image)){t.next=13;break}if(!/^blob:/.test(e.src)){t.next=8;break}n=e,t.next=11;break;case 8:return t.next=10,h.loadImg(e.src);case 10:n=t.sent;case 11:t.next=25;break;case 13:if(t.t0=h,"object"===_typeof(e))return t.next=17,h.readFile(e);t.next=20;break;case 17:t.t1=t.sent,t.next=21;break;case 20:t.t1=e;case 21:return t.t2=t.t1,t.next=24,t.t0.loadImg.call(t.t0,t.t2);case 24:n=t.sent;case 25:t.next=31;break;case 27:return t.prev=27,t.t3=t.catch(2),console.log(t.t3),t.abrupt("return");case 31:if(n){t.next=33;break}return t.abrupt("return");case 33:g.src=n,r=n.width,o=n.height,i=Math.min(1,Math.min(p.width/r,p.height/o)),a=(p.width-r*i)/2,s=(p.height-o*i)/2,y.length=0,l.view={ratio:i,x:a,y:s},l.clean(),l.push({width:r,height:o,sw:r,sh:o});case 42:case"end":return t.stop()}},t,null,[[2,27]])}));return function(t){return e.apply(this,arguments)}}(),this.resize=function(t,e){var n=l.state,r=n.width,o=n.height,n=f.ratio;e=+e,(t=+t)&&e?n*=Math.min(r/t,o/e):t?(n*=r/t,e=t/(r/o)):e&&(n*=o/e,t=r/o*e),l.view={ratio:n},g.resize(t,e),l.push({width:t,height:e})},this.crop=function(){var t,e=d.x,n=d.y,r=d.width,o=d.height,i=f.x,a=f.y,s=f.ratio,c=l.state,u=c.width,h=c.height;u*=s,h*=s,l.range={x:0,y:0,width:0,height:0},r&&r&&i<e+r&&a<n+o&&e<i+u&&n<a+h&&(t=Math.max(0,e-i),c=Math.max(0,n-a),r=Math.min(i+u,e+r)-Math.max(i,e),o=Math.min(a+h,n+o)-Math.max(a,n),t<=i&&c<=a&&u<=r&&h<=o||(g.crop(r/s,o/s,t/s,c/s),Object.assign(f,{x:Math.max(e,i),y:Math.max(n,a)}),l.push({width:g.width,height:g.height,x:Math.max(e,i),y:Math.max(n,a)})))},this.rotate=function(t){g.rotate(t);var e=g.width,t=g.height;l.push({width:e,height:t,angle:g.angle})},this.toDataURL=function(){return g.toDataURL(0<arguments.length&&void 0!==arguments[0]?arguments[0]:"image/jpeg",1<arguments.length&&void 0!==arguments[1]?arguments[1]:.8)},this.toBlob=function(){return g.toBlob(0<arguments.length&&void 0!==arguments[0]?arguments[0]:"image/jpeg",1<arguments.length&&void 0!==arguments[1]?arguments[1]:.8)},this.destroy=function(){p&&n.forEach(function(t){p.removeEventListener(t,e)}),p=null},this.canvas=t}return _createClass(s,[{key:"prev",value:function(){this.historyIndex=this.historyIndex-1}},{key:"next",value:function(){this.historyIndex=this.historyIndex+1}},{key:"scale",value:function(t,e){var n,r,o,i,a,s,c;t<.1||10<t||(r=(n=this.view).x,o=n.y,i=n.ratio,a=(c=this.state).width,s=c.height,c=t-i,e&&v.offsetX>r&&v.offsetY>o&&v.offsetX<r+a*i&&v.offsetY<o+s*i?(n.x-=(v.offsetX-r)/i*c,n.y-=(v.offsetY-o)/i*c):(n.x-=a*c*.5,n.y-=s*c*.5),n.ratio=t,this.view=n)}}]),s}(),t.Sprite=u,t.Utils=h,Object.defineProperty(t,"__esModule",{value:!0})});